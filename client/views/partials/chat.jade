script(src='js/lib/chat.js')
script(src='js/lib/datepicker.js')
script(src='js/lib/ba-emotify.js')
script.
    window.is_logged = 1;
    
    // Load an Adium Emoticonset.
    function emo_set_load( emoticon_set, callback ) {
        var emoticons_base = '../../img/emoticons/' + emoticon_set + '/',
            obj = {};
    
        // For some reason, jQuery's :contains doesn't seem to work when parsing XML in IE.
        function contains( text ) {
            return function() {
                return ( this.textContent || this.text || '' ).indexOf( text ) !== -1;
            }
        };
        
        //dataType: The web server must be configured to serve .plist files as text/xml
        //url: The XML file that defines the Adium Emoticonset.
        //success: Parse Adium Emoticonset .plist file.
        $.ajax({
            dataType: 'xml',
            url: emoticons_base + 'Emoticons.plist',
            success: function( data, textStatus ){
                $(data).find( 'plist > dict > dict > key' ).each(function(){
                    var that = $(this),
                        image = that.text(),
                        equivalents = that.next().children().filter( contains('Equivalents') ).next().children(),
                        name = that.next().children( 'key' ).filter( contains('Name') ).next().text(),
                        text,
                        arr = [];
                        
                    //console.log( image, equivalents.length, name );
                        
                    equivalents.each(function(){
                        text = $(this).text();
                        text && arr.push( text );
                    });
                    obj[ arr.shift() ] = [ emoticons_base + image, name ].concat( arr );
                });
                // Overwrite all current emoticons with those in the Emoticonset.
                callback( emotify.emoticons( true, obj ) );
            },
            // Oops?
            error: function() {
                callback( false );
            }
        });  
    };
    
    // When an Adium Emoticonset is loaded, update the page.
    function emo_set_onload( emoticons ) {
        if ( !emoticons ) {
            //console.log( 'Error loading emoticons!' );
            return;
        }
        
        var html = '',
            cols = 7,
            i = 0;
        
        $.each(emotify.emoticons(), function(key,val){
            html += i % cols == 0 ? "<tr>" : "";
            html += "<td> <img src='" + val[0] + "' alt='"  + val[1] + "' title='" + val[2] + "' />";
            html += i % cols == cols -1 ? "</tr>" : "";
            i++;
        });
        
        $(".chatwrap").append("<div id='emoticonContainer'><table id='emoticonTable'>" + html + "</table></div>");
        
    };

    $(function(){
        emo_set_load('simple', emo_set_onload);
        
        setTimeout(function(){
            $('html').click(function() {
                $( "#emoticonContainer" ).hide("slow");
            });
            
            $('#emoticonContainer').click(function(event){
                event.stopPropagation();
            });
            
            $("#btnEmoticon").click(function(event) {
                var disAttr = $('#data').attr('disabled');
                if (disAttr != 'undefined' && disAttr != 'disabled'){
                    if($('#emoticonContainer').css('display') == 'none'){
                        $( "#emoticonContainer" ).show("slow");
                    }
                    else{
                        $( "#emoticonContainer" ).hide("slow");
                    }
                    event.stopPropagation();
                }
            });
            
            $('#emoticonContainer img').click(function() {
                var text = $(this).attr('title');
                $('#data').val( $('#data').val() + ' ' + text );
            });
        }, 1000);
    });

#section3.section 
    .user
        .preview-loading
        .inside
            form
                fieldset.fieldsetProfile
                    legend {{otherUserInfo.username}} Profile
                    input#confirm(type='button', ng-click='otherUser()', style='display: none;')
                    .row-fluid.profilepic
                        img.img-rounded(ng-src='{{otherUserInfo.avatar}}')
                div(ng-hide='validations.anonymOtherUser')
                    div(ng-hide='validations.anonymOtherUserValidationFields.Name')
                        label Name
                        label {{otherUserInfo.name}}
                    div(ng-hide='validations.anonymOtherUserValidationFields.Birth')
                        label Birth
                        label {{otherUserInfo.birth}}
                    div(ng-hide='validations.anonymOtherUserValidationFields.Email')
                        label Email
                        label {{otherUserInfo.email}}
                    div(ng-hide='validations.anonymOtherUserValidationFields.Location')
                        label Location
                        label {{otherUserInfo.location}}
                    div(ng-hide='validations.anonymOtherUserValidationFields.Gender')
                        label Gender
                        label {{otherUserInfo.gender}}
                    div(ng-hide='validations.anonymOtherUserValidationFields.Description')
                        label About you
                    div(ng-hide='validations.anonymOtherUserValidationFields.Description')
                        .well
                            {{otherUserInfo.description}}
    .chatwrap
        #conversation
        form.form-inline
            .row-fluid
                .chatSendContainer
                    input#data(placeholder='Press enter to send' , ngChange="pullDown()" ,type="text", disabled='disabled')
                    input#datasend(type='button', value='send')
                    .btnEmoticon(id="btnEmoticon")
    .profile
        .inside
            .btn-group.logout.pull-right(ng-hide='validations.anonymUser')
                button.btn(ng-click="logout()") 
                    i.icon-off
                    button.btn.dropdown-toggle(data-toggle='dropdown')
                        span.caret
                    ul.dropdown-menu.pull-right
                        li(ng-click="deleteAccount()") Delete Account
            .info(ng-init='loadInfo()')
                .daysleftwrap(ng-hide='validations.anonymUser')
                    .daysleft(ng-show='newpermit.days')
                        label
                            strong
                                | You have 
                                span.text-error
                                    {{days}} 
                                | days left to confirm your account via email. Click 
                                span.text-error.hereclick(ng-click="resend()") here 
                                | to resend it to your email
                .daysleft(ng-show='newpermit.email') 
                    p.text-success 
                        strong Email has been send
                form(name='registerForm', ng-upload='ng-upload', method='POST', action='/API/upload')
                    fieldset
                        legend {{userInformation.usernameToShow}} Profile
                        input#username(type='hidden', value='{{userInformation.username}}')
                        .row-fluid.profilepic
                            .span12
                                img.img-rounded(ng-src='{{userInformation.avatar}}')
                                ul
                                    li#deleteclick(ng-click="deletePhoto()")
                                        i.icon-remove
                                    li#uploadclick(ng-click="uploadClick()")
                                        i.icon-upload
                            .span10
                                .btn-group.uploadimgtrue(ng-hide='validations.anonymUser')
                                    p
                                        input#fileimg(type='file', name='file')
                                    p
                                        input.btn#imgbtn(upload-submit='uploadImage(content)', type='submit', value='Submit')
                                        
                        div(ng-hide='validations.anonymUser')
                            label Name
                            input.FocusAccion#inputUsername(name='name', id='name', ng-model='userInformation.name', type='text', placeholder = "Name")
                        div(ng-hide='validations.anonymUser')
                            label Birthday
                            input#datepicker(name='datepicker', type='text' , ng-model='userInformation.birth')
                        div(ng-hide='validations.anonymUser')
                            label(ng-hide='validations.anonymUser') Email
                            input.FocusAccion#inputUsername(name='email', id='email', ng-model='userInformation.email', type='text', placeholder = "Email contact")
                        div(ng-hide='validations.anonymUser')
                            label(ng-hide='validations.anonymUser') Location
                            input.FocusAccion#locationapi(type='text', placeholder='Where are you?' , ng-model='userInformation.location')
                            .share
                                label Would you like to share your location?
                                    input#checklocation(type="checkbox" , ng-model="confirmed" , ng-change="locationBool(); updateUsers();")
                        div.sex(ng-hide='validations.anonymUser')
                            label Gender
                            .btn-group
                                a.btn.dropdown-toggle(data-toggle='dropdown', href='#')
                                    | {{userInformation.gender}} 
                                    span.caret
                                ul.dropdown-menu
                                    li#male 
                                        a(ng-click="userInformation.gender = 'Male'; updateUsers();") Male
                                    li#female 
                                        a(ng-click="userInformation.gender = 'Female'; updateUsers();") Female
                                    li#other 
                                        a(ng-click="userInformation.gender = 'Other'; updateUsers();") Other
                        div(ng-hide='validations.anonymUser')
                            label(ng-hide='validations.anonymUser') About you
                            textarea.FocusAccion(name='about', id='about', ng-model='userInformation.description', type='text', placeholder = "Description")
                        div
                            label.updateUser(ng-click="updateUsers()")
        div(ng-init="initchat()")