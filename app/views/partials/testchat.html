<video id="webrtc-sourcevid" autoplay="" style="width: 320px; height: 240px; border: 1px solid black;"></video>
<button type="button">Start video</button>
<button type="button" onclick="stopVideo();">Stop video</button>
<video id="webrtc-remotevid" autoplay="" style="width: 320px; height: 240px; border: 1px solid black;"></video>
<button type="button" onclick="connect();">Connect</button>
<button type="button" onclick="hangUp();">Hang Up</button>

<script>

  // create socket
  var hostURL = window.location.host.split(':')[0],
      portURL = window.location.host.split(':')[1] !== undefined ? window.location.host.split(':')[1] : 80,
      socket = io.connect(hostURL, {port: portURL});

  var sourcevid = document.getElementById('webrtc-sourcevid');
  var remotevid = document.getElementById('webrtc-remotevid');
  var localStream = null;
  var peerConn = null;
  var started = false;
  var channelReady = false;
  var mediaConstraints = {'mandatory': {
    'OfferToReceiveAudio':true,
    'OfferToReceiveVideo':true }};
  var isVideoMuted = false;
  var RTCPeerConnection;
  var RTCSessionDescription;

  //Set local video
  function startVideo() {

    //Choose kind of browser
    if (navigator.getUserMedia){
      navigator.getUserMedia = navigator.getUserMedia;
      RTCPeerConnection = RTCPeerConnection;
      RTCSessionDescription = RTCSessionDescription;
      window.URL = window.URL;
    }
    else {
      if (navigator.webkitGetUserMedia) {
        navigator.getUserMedia = navigator.webkitGetUserMedia;
        RTCPeerConnection = webkitRTCPeerConnection;
        RTCSessionDescription = RTCSessionDescription;
        window.URL = window.URL || window.webkitURL;
      }
      else {
        if (navigator.mozGetUserMedia) {
          navigator.getUserMedia = navigator.mozGetUserMedia;
          RTCPeerConnection = mozRTCPeerConnection;
          RTCSessionDescription = mozRTCSessionDescription;
          window.URL = window.URL;
        }
        else {
          navigator.getUserMedia = navigator.msGetUserMedia;
          RTCPeerConnection = RTCPeerConnection;
          RTCSessionDescription = RTCSessionDescription;
          window.URL = window.URL;
        }
      }
    }

    //Get local video working
    navigator.getUserMedia({video: true, audio: true}, successCallback, errorCallback);
    function successCallback(stream) {
      localStream = stream;
      if (sourcevid.mozSrcObject) {
        sourcevid.mozSrcObject = stream;
        sourcevid.play();
      } else {
        try {
          sourcevid.src = window.URL.createObjectURL(stream);
          sourcevid.play();
        } catch(e) {
          //Error setting video
        }
      }
    }
    function errorCallback(error) {
      //Error error.code
      return;
    }
  }

  //Stop local video
  function stopVideo() {
    if (sourcevid.mozSrcObject) {
      sourcevid.mozSrcObject.stop();
      sourcevid.src = null;
    } else {
      sourcevid.src = "";
      localStream.stop();
    }
  }

  //Send description to socket
  function setLocalAndSendMessage(sessionDescription) {
    peerConn.setLocalDescription(sessionDescription);
    socket.emit('sessionDescription', sessionDescription);
  }

  function createOfferFailed() {
    console.log("Create Answer failed");
  }

  //Start connection between users
  function connect() {
    if (!started && localStream && channelReady) {
      createPeerConnection();
      started = true;
      peerConn.createOffer(setLocalAndSendMessage, createOfferFailed, mediaConstraints);
    } else {
      //Local stream not running
    }
  }

  //Stop streaminh between users
  function hangUp() {
    socket.json.send({type: "bye"});
    stop();
  }

  function stop() {
    peerConn.close();
    peerConn = null;
    started = false;
  }

  function onChannelOpened(evt) {
    socket.emit('adduser', 'Anonym', 'video');
  }

  function createAnswerFailed() {
    //Create answer failed
  }

  //Messages
  function onMessage(evt) {
    if (evt.type === 'offer') {
      console.log("Received offer...")
      if (!started) {
        createPeerConnection();
        started = true;
      }
      console.log('Creating remote session description...');
      console.log(peerConn);
      peerConn.setRemoteDescription(new RTCSessionDescription(evt));
      console.log('Sending answer...');
      peerConn.createAnswer(setLocalAndSendMessage, createAnswerFailed, mediaConstraints);

    } else if (evt.type === 'answer' && started) {
      console.log('Received answer...');
      console.log('Setting remote session description...');
      peerConn.setRemoteDescription(new RTCSessionDescription(evt));

    } else if (evt.type === 'candidate' && started) {
      console.log('Received ICE candidate...');
      var candidate = new RTCIceCandidate({sdpMLineIndex:evt.sdpMLineIndex, sdpMid:evt.sdpMid, candidate:evt.candidate});
      console.log(candidate);
      peerConn.addIceCandidate(candidate);

    } else if (evt.type === 'bye' && started) {
      console.log("Received bye");
      stop();
    }
  }

  function createPeerConnection() {
    var pc_config = {"iceServers":[]};
    try {
      peerConn = new RTCPeerConnection(pc_config);
    } catch (e) {
      //Failed to create PeerConnection
    }

    //Send candidates to the other peer (socket)
    peerConn.onicecandidate = function (evt) {
      if (event.candidate) {
        socket.emit('candidate', {type: "candidate",
          sdpMLineIndex: evt.candidate.sdpMLineIndex,
          sdpMid: evt.candidate.sdpMid,
          candidate: evt.candidate.candidate});
      }
    };

    //Adding local stream
    peerConn.addStream(localStream);

    peerConn.addEventListener("addstream", onRemoteStreamAdded, false);
    peerConn.addEventListener("removestream", onRemoteStreamRemoved, false)

    //Setting local element when remote adds a stream
    function onRemoteStreamAdded(event) {
      remotevid.src = window.URL.createObjectURL(event.stream);
    }

    //Removes element
    function onRemoteStreamRemoved(event) {
      remotevid.src = "";
    }
  }


    // socket: channel connected
    socket.on('connect', onChannelOpened);
    socket.on('message', onMessage);

    socket.on('initialVideo', function(data) {
      channelReady = true;
      startVideo();
      socket.emit('nextVideo');
    });

</script>